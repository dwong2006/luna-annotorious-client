
<html>
  <head>
  <script type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>
  <script type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/js/bootstrap.min.js'></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/3.0.0/openseadragon.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.7.6/dist/openseadragon-annotorious.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-toolbar@0.1.1/dist/annotorious-toolbar.min.js"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.7.6/dist/annotorious.min.css">
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.2/css/bootstrap.min.css'>
  
  <script>
    var clientAppHostUrl = 'http://localhost:5173';
    var lunaUrl = 'https://clone.davidrumsey.com/luna/servlet';
    const loginUrl = lunaUrl + "/login?origin="+clientAppHostUrl+"/callback.htm";
    const getTokenUrl = lunaUrl + "/token?messageId=1&origin="+clientAppHostUrl+"/token_test.html";

  
    window.onload = function() {
      var viewer = OpenSeadragon({
        id: "openseadragon",
        prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/3.0.0/images/",
        tileSources: "https://www.davidrumsey.com/luna/servlet/iiif/RUMSEY~8~1~272964~90046789",
        gestureSettingsTouch: {
          pinchRotate: true
        }
      });
  
      var anno = OpenSeadragon.Annotorious(viewer, {
        locale: 'auto',
        allowEmpty: true
      });
  
      Annotorious.Toolbar(anno, document.getElementById('toolbar'));
  
      let annoListUrl = 'https://www.davidrumsey.com/luna/servlet/iiif/annotation/oa/search?uri=https%3A%2F%2Fwww.davidrumsey.com%2Fluna%2Fservlet%2Fiiif%2Fm%2FRUMSEY~8~1~272964~90046789%2Fcanvas%2Fc1&media=image&limit=10000&_=1654013978941';
      $.get(annoListUrl, function(o){
        o = JSON.parse(o);
        $(o).each(function(){
          var a = this;
          console.log(a);
          var lunaAnno = {'@context':'http://www.w3.org/ns/anno.jsonld','id':a['@id'],'type':'Annotation'};
          var annoBody = {'purpose':'commenting','type':'TextualBody','value':a.resource.chars};
          lunaAnno.body = [];
          lunaAnno.body.push(annoBody);
          lunaAnno.target={'selector':{}};
          lunaAnno.target.selector.type='FragmentSelector';
          lunaAnno.target.selector.conformsTo='http://www.w3.org/TR/media-frags/';
          let v = a.on.selector.value;
          lunaAnno.target.selector.value='xywh=pixel:'+v.substring(v.indexOf('=')+1);
          
          console.log(lunaAnno);
          anno.addAnnotation(lunaAnno);
          //anno.addAnnotation(sampleAnnotation);
        });
      });
    }
    
    var doLogin = function() {
      var child = window.open( loginUrl, "_blank", "height=377,width=606");
          
      var leftDomain = false;
      var interval = setInterval(function() {
        try {
          if (child.document.domain === document.domain) {
            if (leftDomain && child.document.readyState === "complete") {
              // we're here when the child window returned to our domain
              clearInterval(interval);
              alert("Login popup window calls back this page: " + child.document.URL);
              child.postMessage({ message: "requestResult" }, "*");
            }
          }
          else {
            // this code should never be reached, 
            // as the x-site security check throws
            // but just in case
            leftDomain = true;
          }
        }
        catch(e) {
          // we're here when the child window has been navigated away or closed
          if (child.closed) {
            clearInterval(interval);
            alert("closed");
            return; 
          }
          // navigated to another domain  
          leftDomain = true;
        }
      }, 500);
    };
  
    var getToken = function()
    {
      console.log('getToken');
        
      ifrm = $('<iframe>').attr('scrolling','no').attr('frameborder','0').attr('width','100%').attr('height','100%').attr('aria-label','media viewer').attr('style','z-index: -1;-ms-overflow-style:none');
      templateContainer = ifrm[0];
      //ifrm.attr('onload','notifyTemplate()');
      ifrm.attr('src', getTokenUrl);
      $('#TokenPage').empty();
      $('#TokenPage').append(ifrm);
    };
    
    window.addEventListener("message", function(ev) {
      data = ev.data;
      console.log("Parent: Received event " + JSON.stringify(event) + " data: " + data);
      // receive login confirmation
      if (ev.data.message === "deliverResult") {
          alert("Received signal from callback page. Closed the popup. Result: " + ev.data.result);
          ev.source.close();
      }
      // receive token
      var token, error;
      var json = JSON.parse( data );
      if (json.hasOwnProperty('accessToken')) {
          token = json.accessToken;
          alert('Parent: Received access token: ' + token);
          $('#DebugLinkContainer').empty();
          $('#DebugLinkContainer').append('<a target=_blank href="https://jwt.io/#debugger-io?token=' + token +'">Debug token on jwt.io</a>');
          $('#DebugLinkContainer').show();
      } else {
          // handle error condition
      }
    });
  
      
    $(document).ready(function(){
      $('#Login').click(doLogin);
      $('#GetToken').click(getToken);
    });
  
  </script>
  
  </head>
  <body>
    <div class="container-fluid">
      <div class="row" style="margin:5px;"><div class="col-sm-2"><button id="Login" type="button" class="btn btn-secondary">Step 1 - Login</button></div><div class="col-sm-6">Reference: <a href="https://iiif.io/api/auth/1.0/#login-interaction-pattern">Access Cookie Service: Login Interaction Pattern</a></div><div class="col-sm-2">Base 64 Encoded Secret: yYd1bvEVMvRmC0t25aZKj9ENntstUi9y7kYlOoopdYc=</div></div>
      <div class="row" style="margin:5px;"><div class="col-sm-2"><button id="GetToken" type="button" class="btn btn-secondary">Step 2 - Get Token</button></div><div class="col-sm-6">Reference: <a href="https://iiif.io/api/auth/1.0/#interaction-for-browser-based-client-applications">Access Token Service: Interaction for Browser-Based Client Applications</a></div><div class="col-sm-2"><div class="alert alert-primary" style="display:none;" id="DebugLinkContainer"></div></div></div>
      <div class="row" style="margin:5px;"><div class="col-sm-2"><div class="alert alert-primary" style="display:none;" id="DebugLinkContainer"></div></div></div>
    </div>
    
    <div id="toolbar"></div>
    <div id="openseadragon"></div>
    <div id="TokenPage" style="display:none;"></div>
  </body>
  </html>
  